---
title: "Practical courses"
author: "Amin Madoui and Romuald Laso-Jadart"
date: "April 2021"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#   Estimation of the genomic differentiation
##    Allele frequency spectrum

 ```{r}
 data=read.table('data/RC/S155.txt')
 colnames(data) = c("GA","GB","TA","TB")
 Gfreq = data$GB/(data$GA+data$GB)
 hist(Gfreq, breaks = 10, main="B allele frequency distribution")
 ```
 ##Pairwise-FST
 ```{r}
source ("popgene_functions.R")
 
freq = read.table("data/Genomic_frequencies.txt")
colnames(freq) = c("S155","S158","S178","S206","S208","S209","S210")

pairwiseFST = pwFst(freq)

print(pairwiseFST)
 
plotFST(pairwiseFST)
 ```
 
 ##Isolation by currents   
 
 
 # Detection of loci under natural selection
 
 ##FST outliers method through LK
  ```{r}
source ("popgene_functions.R")
 
freq = read.table("data/Genomic_frequencies.txt")
colnames(freq) = c("S155","S158","S178","S206","S208","S209","S210")

LK = LK(freq)
head( LK)

h = hist ( LK$LK , plot = F, breaks = 50 )
n_pop = ncol(freq)-1
hist ( LK$LK, freq = F, xlab = "LK" , breaks = 50 , main = "LK distribution")

# add the neutral evolution
curve ( dchisq( x, n_pop ) , lwd=3, col="orange" , add=T )

# selected loci with high LK value
selection_LK = LK[LK$q_value<0.1,]
dim(selection_LK)
 ```
 
 ##pcadapt method
 
 #Population-scale allele expression
 ##Comparison of allele expression to genomic abundance
 
  ```{r}
 data=read.table('data/RC/S206.txt')
 colnames(data) = c("GA","GB","TA","TB")
 Gfreq = data$GB/(data$GA+data$GB)
 Tfreq = data$TB/(data$TA+data$TB)
 plot(Gfreq,Tfreq)
 summary(lm(Tfreq~Gfreq-1))
 ```
 ##Detection of allele-specific expression (ASE)
 
 ```{r}
  Fisher_pvalue = apply(data,1,function (x) fisher.test (matrix(x, nrow = 2))$p.value)
  Fisher_qvalue = p.adjust(Fisher_pvalue, method="BH")
 ```
 ##Link between natural selection and allele specific expression
 
  ```{r}
  selection_ASE_S206 = LK[LK$q_value<0.1 &  Fisher_qvalue < 0.1,] 
  dim(selection_ASE_S206)
  phyper(nrow(selection_ASE_S206), 
        nrow(LK[LK$q_value<0.1,]),
        nrow(LK)-nrow(LK[LK$q_value<0.1,]),
        length(Fisher_qvalue[Fisher_qvalue<0.1] ))
  
 ```
 #Reference-free approach and metavariant species
 ##Genomic differentiation of MVS
 ##Role of the environmental factors
 ##Variance partitioning of environmental factors



