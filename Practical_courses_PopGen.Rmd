---
title: "Practical courses"
author: "Amin Madoui and Romuald Laso-Jadart"
date: "April 2021"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#   Estimation of the genomic differentiation
##    Allele frequency spectrum

 ```{r }
 data=read.table('data/RC/S155.txt') 
 
 colnames(data) = c("GA","GB","TA","TB") 
 
 Gfreq = data$GB/(data$GA+data$GB)  
 
 hist(Gfreq, breaks = 10, main="B allele frequency distribution")  
 ```
 
 ##  Pairwise-FST
 
 ```{r }
source ("popgene_functions.R")  
 
freq = read.table("data/Genomic_frequencies.txt")  

colnames(freq) = c("TARA_155","TARA_158","TARA_178","TARA_206","TARA_208","TARA_209","TARA_210")  

pairwiseFST = pwFst(freq)  

print(pairwiseFST)  
 
plotFST(pairwiseFST)  
 ```
 
 ## Isolation by distances
 
```{r}
euclideans = read.table("data/Euclidean_Arctic.txt", row.names=1,header = TRUE)
 
#MantelPlot(euclideans,pairwiseFST)
 
res_mantel_euclideans = mantel(vegdist(pairwiseFST),vegdist(euclideans))

```

## ISolation by currents

```{r }
lagrangians = read.table("data/Lagrangian_Arctic.txt", row.names=1,header = TRUE)
 
#MantelPlot(euclideans,pairwiseFST)
 
res_mantel_lagrangians = mantel(vegdist(pairwiseFST),vegdist(lagrangians))

```
  
 # Detection of loci under natural selection
 
 ## The LK outliers method 
 
  ```{r }
source ("popgene_functions.R")  
 
freq = read.table("data/Genomic_frequencies.txt")  

colnames(freq) = c("S155","S158","S178","S206","S208","S209","S210")  

LK = LK(freq)  

head( LK)  

h = hist ( LK$LK , plot = F, breaks = 50 )  

n_pop = ncol(freq)-1  

hist ( LK$LK, freq = F, xlab = "LK" , breaks = 50 , main = "LK distribution")  

# add the neutral evolution  

curve ( dchisq( x, n_pop ) , lwd=3, col="orange" , add=T )  

# selected loci with high LK value 

selection_LK = LK[LK$q_value<0.1,]  

dim(selection_LK)  
 ```
 
 ## using the pcadapt package
 ```{r}
library(pcadapt)
 
freq = read.table("data/Genomic_frequencies.txt")  

colnames(freq) = c("S155","S158","S178","S206","S208","S209","S210")  

freq_forPCA = read.pcadapt(freq, type = "pool")

pcadapt_result <- pcadapt(t(freq_forPCA), K = 4)

q_values = p.adjust(pcadapt_result$pvalues, method = "BH")

freq$pcadapt_qval = q_values

freq[is.na(freq)] <- 1

dim(freq[freq$pcadapt_qval<0.1,])

freq$LK_qval = LK$q_value

dim(freq[freq$pcadapt_qval<0.1 & freq$LK_qval<0.1,])

 ```
 
 # Population-scale allele expression  
 
 ## Comparison of allele expression to genomic abundance
 
  ```{r }
 data=read.table('data/RC/S206.txt') 
 
 colnames(data) = c("GA","GB","TA","TB")  
 
 Gfreq = data$GB/(data$GA+data$GB)  
 
 Tfreq = data$TB/(data$TA+data$TB) 
 
 plot(Gfreq,Tfreq)  
 
 summary(lm(Tfreq~Gfreq-1))  
 ```
 
 ## Detection of allele-specific expression (ASE)
 
 ```{r}
  Fisher_pvalue = apply(data,1,function (x) fisher.test (matrix(x, nrow = 2))$p.value) 
  
  Fisher_qvalue = p.adjust(Fisher_pvalue, method="BH")  
 ```
 
 ## Link between natural selection and allele specific expression
 
  ```{r}
  cutoff = 0.01
  
  selection_ASE_S206 = freq[freq$pcadapt_qval<cutoff &  Fisher_qvalue < cutoff,]   
  
  dim(selection_ASE_S206)
  
  phyper(nrow(selection_ASE_S206),   
        nrow(freq[freq$pcadapt_qval<cutoff,]),  
        nrow(freq)-nrow(freq[freq$pcadapt_qval<cutoff,]),  
        length(Fisher_qvalue[Fisher_qvalue<cutoff] ))  
  
 ```
 
 # Reference-free approach and metavariant species
 
  ```{r }
  
 MVS.List = readMvsList("data/MVS")
  
  ```
 ## Genomic differentiation of MVS
 
   ```{r }
  
  plotFST(MVS.List[[i]]@pwFst)
  
  ```
 
 ## Role of the environmental factors
 
  ```{r }
EnvTable = read.table("data/WorldOceanAtlas_data.txt",header = T)
envlist = list(Temperature = EnvTable[,c(1,7)],
             Salinity = EnvTable[,c(1,8)],
             Silicate = EnvTable[,c(1,4)],
             Po4 = EnvTable[,c(1,6)], 
             No3 = EnvTable[,c(1,5)])

LagrangianMatrix = read.table("data/Lagrangian_Matrix.txt",header = T)
ggplot(data = melt(as.matrix(LagrangianMatrix)), aes(Var1,Var2, fill = value)) + 
  geom_tile(color = "white",names ="Travel Time (days)") + scale_fill_viridis() + 
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
        axis.text.x = element_text(angle=90,vjust = 0.8 ), 
        axis.text.y = element_text(vjust = 0.8 )) +
  xlab("") + ylab("")
 
  ```
  
 ## Variance partitioning of environmental factors
 
   ```{r}
   
VariancePartition.Res = LinearMixedModelMVS(MVS.List[["Copepod"]],LagrangianMatrix,envlist)
PlotLMM(VariancePartition.Res) 

  ```
